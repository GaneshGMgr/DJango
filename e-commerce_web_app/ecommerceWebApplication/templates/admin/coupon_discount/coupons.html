{% extends "admin/admin_base.html" %}

{% block title %}Coupons{% endblock %}

{% block adminbody %}

{% if request.user.is_authenticated and request.user.is_staff and request.user.is_active %}

<div class="container-fluid py-4">
    <!-- Stats Cards Row -->
    <div class="row g-4 mb-4">
        <!-- Active Coupons -->
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card stat-card shadow-sm" style="border-left: 4px solid #28a745;">
                <div class="card-body">
                    <h6 class="text-muted small text-uppercase fw-bold">Active Coupons</h6>
                    <h3 class="fw-bold mb-1">{{ active_coupons }}</h3>
                    <div class="text-success small">
                        <i class="fas fa-tags me-1"></i> Currently Valid
                    </div>
                </div>
            </div>
        </div>

        <!-- Expired Coupons -->
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card stat-card shadow-sm" style="border-left: 4px solid #dc3545;">
                <div class="card-body">
                    <h6 class="text-muted small text-uppercase fw-bold">Expired Coupons</h6>
                    <h3 class="fw-bold mb-1">{{ expired_coupons }}</h3>
                    <div class="text-danger small">
                        <i class="fas fa-clock me-1"></i> No Longer Valid
                    </div>
                </div>
            </div>
        </div>

        <!-- Total Redemptions -->
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card stat-card shadow-sm" style="border-left: 4px solid #17a2b8;">
                <div class="card-body">
                    <h6 class="text-muted small text-uppercase fw-bold">Total Redemptions</h6>
                    <h3 class="fw-bold mb-1">{{ total_redemptions }}</h3>
                    <div class="text-info small">
                        <i class="fas fa-shopping-cart me-1"></i> All Time Usage
                    </div>
                </div>
            </div>
        </div>

        <!-- Avg Discount -->
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card stat-card shadow-sm" style="border-left: 4px solid #6f42c1;">
                <div class="card-body">
                    <h6 class="text-muted small text-uppercase fw-bold">Avg. Discount</h6>
                    <h3 class="fw-bold mb-1">{{ avg_discount }}%</h3>
                    <div class="text-primary small">
                        <i class="fas fa-percentage me-1"></i> Average Value
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Coupons Table -->
    <div class="card mb-4 border-0 shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center bg-white border-bottom">
            <div>
                <h5 class="mb-0"><i class="fas fa-tag me-2 text-primary"></i> Coupon Management</h5>
                <p class="small text-muted mb-0">Last updated: {{ last_updated }}</p>
            </div>
            <div>
                <button class="btn btn-sm btn-outline-secondary me-2" id="exportBtn">
                    <i class="fas fa-download me-1"></i> Export
                </button>
                <button class="btn btn-sm btn-primary" id="addCouponBtn" data-bs-toggle="modal" data-bs-target="#couponModal">
                    <i class="fas fa-plus me-1"></i> Create Coupon
                </button>
            </div>
        </div>
        
        <!-- Search and Filter Section -->
        <div class="card-body border-bottom bg-light">
            <div class="row g-3 align-items-center">
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text bg-white"><i class="fas fa-search"></i></span>
                        <input type="text" class="form-control" id="searchInput" placeholder="Search coupons...">
                    </div>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="statusFilter">
                        <option value="all">All Statuses</option>
                        <option value="active">Active</option>
                        <option value="upcoming">Upcoming</option>
                        <option value="expired">Expired</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="typeFilter">
                        <option value="all">All Types</option>
                        <option value="percentage">Percentage</option>
                        <option value="fixed">Fixed Amount</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="usageFilter">
                        <option value="all">All Usage</option>
                        <option value="unused">Unused</option>
                        <option value="partially_used">Partially Used</option>
                        <option value="fully_used">Fully Used</option>
                    </select>
                </div>
                <div class="col-md-2 d-flex gap-2">
                    <button class="btn btn-outline-primary flex-grow-1" id="applyFiltersBtn">
                        <i class="fas fa-filter me-1"></i> Apply
                    </button>
                    <button class="btn btn-outline-secondary" id="resetFiltersBtn">
                        <i class="fas fa-undo"></i> Reset
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Bulk Action Panel (hidden by default) -->
        <div id="bulkActionPanel" class="bg-light p-3 border-bottom" style="display: none;">
            <div class="d-flex align-items-center">
                <span class="me-3" id="selectedCount">0 coupons selected</span>
                <div class="btn-group">
                    <button class="btn btn-sm btn-outline-danger" id="bulkDeleteBtn">
                        <i class="fas fa-trash me-1"></i> Delete
                    </button>
                    <button class="btn btn-sm btn-outline-success" id="bulkExtendBtn">
                        <i class="fas fa-calendar-plus me-1"></i> Extend Date
                    </button>
                    <button class="btn btn-sm btn-outline-primary" id="bulkIncreaseLimitBtn">
                        <i class="fas fa-plus-circle me-1"></i> Increase Limit
                    </button>
                </div>
                <button class="btn btn-sm btn-link text-danger" id="clearSelectionBtn">
                    <i class="fas fa-times me-1"></i> Clear
                </button>
            </div>
        </div>
        
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0" id="couponsTable">
                    <thead class="table-light">
                        <tr>
                            <th width="50">
                                <input type="checkbox" id="selectAllCheckbox" class="form-check-input">
                            </th>
                            <th>Code</th>
                            <th>Type</th>
                            <th>Value</th>
                            <th>Usage</th>
                            <th>Valid Dates</th>
                            <th>Status</th>
                            <th>Created By</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Active Coupon -->
                        <tr>
                            <td>
                                <input type="checkbox" class="form-check-input row-checkbox" data-id="1">
                            </td>
                            <td class="fw-bold">SUMMER25</td>
                            <td><span class="badge bg-primary bg-opacity-10 text-primary">Percentage</span></td>
                            <td>25%</td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="progress flex-grow-1 me-2" style="height: 6px;">
                                        <div class="progress-bar bg-success" role="progressbar" style="width: 45%"></div>
                                    </div>
                                    <small>9/20</small>
                                </div>
                            </td>
                            <td>
                                <small>Jun 1 - Jun 30, 2023</small>
                            </td>
                            <td><span class="badge bg-success bg-opacity-10 text-success">Active</span></td>
                            <td>Admin User</td>
                            <td class="text-center">
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                        Actions
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item edit-coupon-btn" href="#" data-id="1"><i class="fas fa-edit me-2"></i> Edit</a></li>
                                        <li><a class="dropdown-item view-usage-btn" href="#" data-id="1"><i class="fas fa-users me-2"></i> View Usage</a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item text-danger delete-coupon-btn" href="#" data-id="1"><i class="fas fa-trash me-2"></i> Delete</a></li>
                                    </ul>
                                </div>
                            </td>
                        </tr>
                        
                        <!-- Expired Coupon -->
                        <tr class="table-secondary">
                            <td>
                                <input type="checkbox" class="form-check-input row-checkbox" data-id="2">
                            </td>
                            <td class="fw-bold">SPRING10</td>
                            <td><span class="badge bg-info bg-opacity-10 text-info">Fixed</span></td>
                            <td>$10.00</td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="progress flex-grow-1 me-2" style="height: 6px;">
                                        <div class="progress-bar bg-success" role="progressbar" style="width: 100%"></div>
                                    </div>
                                    <small>15/15</small>
                                </div>
                            </td>
                            <td>
                                <small>Mar 1 - May 31, 2023</small>
                            </td>
                            <td><span class="badge bg-danger bg-opacity-10 text-danger">Expired</span></td>
                            <td>Marketing Team</td>
                            <td class="text-center">
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                        Actions
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item edit-coupon-btn" href="#" data-id="2"><i class="fas fa-edit me-2"></i> Edit</a></li>
                                        <li><a class="dropdown-item view-usage-btn" href="#" data-id="2"><i class="fas fa-users me-2"></i> View Usage</a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item text-danger delete-coupon-btn" href="#" data-id="2"><i class="fas fa-trash me-2"></i> Delete</a></li>
                                    </ul>
                                </div>
                            </td>
                        </tr>
                        
                        <!-- Upcoming Coupon -->
                        <tr class="table-info">
                            <td>
                                <input type="checkbox" class="form-check-input row-checkbox" data-id="3">
                            </td>
                            <td class="fw-bold">BLACKFRI50</td>
                            <td><span class="badge bg-primary bg-opacity-10 text-primary">Percentage</span></td>
                            <td>50%</td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="progress flex-grow-1 me-2" style="height: 6px;">
                                        <div class="progress-bar bg-secondary" role="progressbar" style="width: 0%"></div>
                                    </div>
                                    <small>0/100</small>
                                </div>
                            </td>
                            <td>
                                <small>Nov 24 - Nov 27, 2023</small>
                            </td>
                            <td><span class="badge bg-info bg-opacity-10 text-info">Upcoming</span></td>
                            <td>Marketing Team</td>
                            <td class="text-center">
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                        Actions
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item edit-coupon-btn" href="#" data-id="3"><i class="fas fa-edit me-2"></i> Edit</a></li>
                                        <li><a class="dropdown-item view-usage-btn" href="#" data-id="3"><i class="fas fa-users me-2"></i> View Usage</a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item text-danger delete-coupon-btn" href="#" data-id="3"><i class="fas fa-trash me-2"></i> Delete</a></li>
                                    </ul>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card-footer bg-white d-flex justify-content-between align-items-center">
            <div>
                <select class="form-select form-select-sm w-auto d-inline-block me-2" id="itemsPerPage">
                    <option value="10">10</option>
                    <option value="25">25</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
                <span class="text-muted small">coupons per page</span>
            </div>
            <nav>
                <ul class="pagination pagination-sm mb-0" id="pagination">
                    <li class="page-item disabled">
                        <a class="page-link" href="#" id="prevPage"><i class="fas fa-chevron-left"></i></a>
                    </li>
                    <li class="page-item active"><a class="page-link" href="#">1</a></li>
                    <li class="page-item"><a class="page-link" href="#">2</a></li>
                    <li class="page-item"><a class="page-link" href="#">3</a></li>
                    <li class="page-item">
                        <a class="page-link" href="#" id="nextPage"><i class="fas fa-chevron-right"></i></a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
</div>

<!-- Coupon Modal -->
<div class="modal fade" id="couponModal" tabindex="-1" aria-labelledby="couponModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background-color: #1e293b; color: white; border-bottom: 1px solid #334155;">
                <h5 class="modal-title">Create New Coupon</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="couponForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="couponCode" class="form-label">Coupon Code *</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="couponCode" required>
                                <button class="btn btn-outline-secondary" type="button" id="generateCodeBtn">
                                    <i class="fas fa-random"></i> Generate
                                </button>
                            </div>
                            <small class="text-muted">Uppercase letters and numbers only, 6-20 characters</small>
                        </div>
                        <div class="col-md-6">
                            <label for="couponType" class="form-label">Discount Type *</label>
                            <select class="form-select" id="couponType" required>
                                <option value="">Select Type</option>
                                <option value="percentage">Percentage Discount</option>
                                <option value="fixed">Fixed Amount Discount</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="discountValue" class="form-label">Discount Value *</label>
                            <div class="input-group">
                                <span class="input-group-text" id="valueSymbol">%</span>
                                <input type="number" class="form-control" id="discountValue" min="1" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="maxUses" class="form-label">Usage Limit *</label>
                            <input type="number" class="form-control" id="maxUses" min="1" value="100" required>
                            <small class="text-muted">Maximum number of times this coupon can be used</small>
                        </div>
                        <div class="col-md-6">
                            <label for="validFrom" class="form-label">Valid From *</label>
                            <input type="datetime-local" class="form-control" id="validFrom" required>
                        </div>
                        <div class="col-md-6">
                            <label for="validTo" class="form-label">Valid To *</label>
                            <input type="datetime-local" class="form-control" id="validTo" required>
                        </div>
                        <div class="col-12">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="singleUse">
                                <label class="form-check-label" for="singleUse">Single use per customer</label>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="minPurchase">
                                <label class="form-check-label" for="minPurchase">Require minimum purchase amount</label>
                            </div>
                        </div>
                        <div class="col-md-6" id="minPurchaseAmountContainer" style="display: none;">
                            <label for="minPurchaseAmount" class="form-label">Minimum Purchase Amount</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="minPurchaseAmount" min="0" step="0.01">
                            </div>
                        </div>
                        <div class="col-12">
                            <label for="couponDescription" class="form-label">Description (Optional)</label>
                            <textarea class="form-control" id="couponDescription" rows="2"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveCouponBtn">Save Coupon</button>
            </div>
        </div>
    </div>
</div>

<!-- Usage Details Modal -->
<div class="modal fade" id="usageModal" tabindex="-1" aria-labelledby="usageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="usageModalLabel">Coupon Usage Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <h6 class="text-muted">Coupon Code</h6>
                                <h4>SUMMER25</h4>
                            </div>
                            <div class="col-md-4">
                                <h6 class="text-muted">Discount Value</h6>
                                <h4>25% Off</h4>
                            </div>
                            <div class="col-md-4">
                                <h6 class="text-muted">Usage</h6>
                                <h4>9 of 20 (45%)</h4>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Customer</th>
                                <th>Order #</th>
                                <th>Date Used</th>
                                <th>Order Total</th>
                                <th>Discount Applied</th>
                                <th>Final Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <img src="https://via.placeholder.com/40" width="32" height="32" class="rounded-circle me-2">
                                        <div>John Smith</div>
                                    </div>
                                </td>
                                <td>#ORD-10025</td>
                                <td>Jun 5, 2023 14:32</td>
                                <td>$120.00</td>
                                <td class="text-success">-$30.00</td>
                                <td>$90.00</td>
                            </tr>
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <img src="https://via.placeholder.com/40" width="32" height="32" class="rounded-circle me-2">
                                        <div>Sarah Johnson</div>
                                    </div>
                                </td>
                                <td>#ORD-10018</td>
                                <td>Jun 3, 2023 09:15</td>
                                <td>$80.00</td>
                                <td class="text-success">-$20.00</td>
                                <td>$60.00</td>
                            </tr>
                            <!-- More rows would be populated dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-outline-primary">
                    <i class="fas fa-download me-1"></i> Export Usage Data
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // DOM Elements
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        const rowCheckboxes = document.querySelectorAll('.row-checkbox');
        const bulkActionPanel = document.getElementById('bulkActionPanel');
        const selectedCount = document.getElementById('selectedCount');
        const clearSelectionBtn = document.getElementById('clearSelectionBtn');
        const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
        const bulkExtendBtn = document.getElementById('bulkExtendBtn');
        const bulkIncreaseLimitBtn = document.getElementById('bulkIncreaseLimitBtn');
        const couponModal = new bootstrap.Modal(document.getElementById('couponModal'));
        const usageModal = new bootstrap.Modal(document.getElementById('usageModal'));
        const couponTypeSelect = document.getElementById('couponType');
        const minPurchaseCheckbox = document.getElementById('minPurchase');
        const minPurchaseAmountContainer = document.getElementById('minPurchaseAmountContainer');
        
        // Toggle minimum purchase amount field
        minPurchaseCheckbox.addEventListener('change', function() {
            minPurchaseAmountContainer.style.display = this.checked ? 'block' : 'none';
        });
        
        // Update discount value symbol based on type
        couponTypeSelect.addEventListener('change', function() {
            document.getElementById('valueSymbol').textContent = 
                this.value === 'percentage' ? '%' : '$';
        });
        
        // Generate random coupon code
        document.getElementById('generateCodeBtn').addEventListener('click', function() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let result = '';
            for (let i = 0; i < 8; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            document.getElementById('couponCode').value = result;
        });
        
        // Select All functionality
        selectAllCheckbox.addEventListener('change', function() {
            const isChecked = this.checked;
            rowCheckboxes.forEach(checkbox => {
                checkbox.checked = isChecked;
            });
            updateBulkActionPanel();
        });
    
        // Individual row checkbox functionality
        rowCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', updateBulkActionPanel);
        });
    
        // Clear selection
        clearSelectionBtn.addEventListener('click', function() {
            rowCheckboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            selectAllCheckbox.checked = false;
            bulkActionPanel.style.display = 'none';
        });
    
        // Bulk delete action
        bulkDeleteBtn.addEventListener('click', function() {
            const selectedIds = getSelectedIds();
            if (selectedIds.length > 0) {
                if (confirm(`Are you sure you want to delete ${selectedIds.length} selected coupons?`)) {
                    alert(`Deleted coupons with IDs: ${selectedIds.join(', ')}`);
                    // In a real app, you would make an AJAX call here
                }
            }
        });
    
        // Bulk extend date action
        bulkExtendBtn.addEventListener('click', function() {
            const selectedIds = getSelectedIds();
            if (selectedIds.length > 0) {
                alert(`Extending validity for coupons: ${selectedIds.join(', ')}`);
                // In a real app, you would show a date picker and make an AJAX call
            }
        });
        
        // Bulk increase limit action
        bulkIncreaseLimitBtn.addEventListener('click', function() {
            const selectedIds = getSelectedIds();
            if (selectedIds.length > 0) {
                const newLimit = prompt('Enter new usage limit:');
                if (newLimit) {
                    alert(`Setting new limit of ${newLimit} for coupons: ${selectedIds.join(', ')}`);
                    // In a real app, you would make an AJAX call here
                }
            }
        });
        
        // View usage button click handlers
        document.querySelectorAll('.view-usage-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const couponId = this.getAttribute('data-id');
                // In a real app, you would fetch coupon usage data here
                usageModal.show();
            });
        });
        
        // Edit coupon button click handlers
        document.querySelectorAll('.edit-coupon-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const couponId = this.getAttribute('data-id');
                // In a real app, you would fetch coupon data here
                document.getElementById('couponModalLabel').textContent = 'Edit Coupon';
                couponModal.show();
            });
        });
    
        // Helper function to update bulk action panel visibility
        function updateBulkActionPanel() {
            const checkedCount = document.querySelectorAll('.row-checkbox:checked').length;
            if (checkedCount > 0) {
                bulkActionPanel.style.display = 'block';
                selectedCount.textContent = `${checkedCount} coupons selected`;
                selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < rowCheckboxes.length;
            } else {
                bulkActionPanel.style.display = 'none';
                selectAllCheckbox.indeterminate = false;
            }
        }
    
        // Helper function to get selected IDs
        function getSelectedIds() {
            const selectedIds = [];
            document.querySelectorAll('.row-checkbox:checked').forEach(checkbox => {
                selectedIds.push(checkbox.getAttribute('data-id'));
            });
            return selectedIds;
        }
    });
</script>

{% endif %}
{% endblock %}